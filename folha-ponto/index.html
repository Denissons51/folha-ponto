<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Folha de Ponto Aprimorada</title>
<!-- jsPDF + AutoTable para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Ícones do Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --brand:#2563eb; --brand-2:#10b981; --warn:#f59e0b; --danger:#ef4444; --line:#e5e7eb;
    --bluecell:#eaf2ff; --extracell:#fff6e5; --success-bg:#ecfdf5; --danger-bg:#fef2f2;
    --weekend-bg:#f8f9fa;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:var(--bg); color:var(--ink)}
  header{padding:18px 16px 0}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.04)}
  .toolbar{display:flex; flex-wrap:wrap; gap:12px; align-items:end; padding:16px 20px 12px; border-bottom:1px solid var(--line)}
  .toolbar .group{display:flex; gap:10px; align-items:end; flex-wrap:wrap}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px; font-weight:500}
  input[type="text"], input[type="number"], select{
    padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; color:var(--ink); min-width:120px;
    transition:border-color 0.2s;
  }
  input[type="text"]:focus, input[type="number"]:focus, select:focus{
    border-color:var(--brand); outline:none; box-shadow:0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  input[type="number"]{width:100px}
  .btn{
    appearance:none; border:1px solid var(--line); background:#fff; color:var(--ink);
    padding:10px 16px; border-radius:12px; cursor:pointer; transition:.15s; font-weight:600;
    display:flex; align-items:center; gap:6px;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
  .btn.success{background:var(--brand-2); color:#fff; border-color:transparent}
  .btn.warn{background:var(--warn); color:#fff; border-color:transparent}
  .btn.danger{background:var(--danger); color:#fff; border-color:transparent}
  .titleline{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--line)}
  .titleline h1{font-size:20px; margin:0; display:flex; align-items:center; gap:10px;}
  .titleline small{color:var(--muted); font-size:14px}
  table{width:100%; border-collapse:collapse; border-bottom-left-radius:16px; border-bottom-right-radius:16px; overflow:hidden}
  thead th{position:sticky; top:0; background:#fff; z-index:1; font-weight:600; padding:12px 8px}
  th, td{border-top:1px solid var(--line); padding:10px; text-align:center; font-size:14px}
  th.sticky-left, td.sticky-left{position:sticky; left:0; background:#fff; z-index:2; box-shadow:2px 0 5px rgba(0,0,0,0.05)}
  th.section{background:#f3f4f6; color:#374151; font-weight:700}
  td input{
    width:100%; border:1px solid var(--line); background:#fff; text-align:center; padding:8px 6px; font:inherit; outline:none;
    border-radius:6px; transition:border-color 0.2s;
  }
  td input:focus{border-color:var(--brand); background:#fff; box-shadow:0 0 0 3px rgba(37, 99, 235, 0.1)}
  tbody tr:nth-child(even){background:#fafafa}
  tbody tr.weekend{background:var(--weekend-bg)}
  td.total{background:var(--bluecell); font-weight:700}
  td.extra{background:var(--extracell); font-weight:700}
  tfoot td{font-weight:800; background:#f9fafb}
  .hint{padding:14px 20px; color:var(--muted); font-size:13px; border-top:1px dashed var(--line); background:#fafafa}
  .badge{padding:4px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; font-weight:700}
  .grow{flex:1}
  .export-options {margin-top: 10px; padding: 12px 16px; background: #f9fafb; border-radius: 8px; border: 1px solid var(--line);}
  .export-options label {display: inline-block; margin-right: 12px; font-size: 13px;}
  .stats-container {display: flex; gap: 16px; padding: 12px 20px; background: #f8f9fa; border-bottom: 1px solid var(--line);}
  .stat-box {flex: 1; background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--line); text-align: center;}
  .stat-value {font-size: 18px; font-weight: 700; margin-bottom: 4px;}
  .stat-label {font-size: 12px; color: var(--muted);}
  .positive {color: #10b981;}
  .negative {color: #ef4444;}
  .weekend-label {color: #8b5cf6; font-weight: 500;}
  .action-buttons {display: flex; gap: 10px; padding: 0 20px 16px;}
  .clear-btn {background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;}
  .clear-btn:hover {background: #dc2626; color: white;}
  .highlight {animation: highlight 2s ease;}
  @keyframes highlight {
    0% {background-color: rgba(37, 99, 235, 0.2);}
    100% {background-color: transparent;}
  }
  .fade-in {animation: fadeIn 0.5s ease;}
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  .punch-animation {
    animation: punchEffect 0.5s ease;
  }
  @keyframes punchEffect {
    0% {transform: scale(1);}
    50% {transform: scale(1.05); background-color: #ecfdf5;}
    100% {transform: scale(1);}
  }
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    max-width: 400px;
    width: 100%;
  }
  .modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  @media (max-width: 768px) {
    .toolbar .group {flex-direction: column; align-items: stretch;}
    .toolbar {flex-direction: column;}
    .stats-container {flex-direction: column;}
  }
</style>
</head>
<body>
  <header class="wrap">
    <div class="card">
      <div class="toolbar">
        <div class="group">
          <div>
            <label><i class="fas fa-user"></i> Funcionário</label>
            <input type="text" id="employee" placeholder="Nome do funcionário">
          </div>
          <div>
            <label><i class="fas fa-calendar"></i> Mês</label>
            <select id="month"></select>
          </div>
          <div>
            <label><i class="fas fa-calendar-alt"></i> Ano</label>
            <select id="year"></select>
          </div>
          <div>
            <label><i class="fas fa-bullseye"></i> Alvo diário (h)</label>
            <input type="number" id="dailyTarget" min="1" max="24" step="0.25" value="8">
          </div>
          <button class="btn primary" id="generate">
            <i class="fas fa-sync-alt"></i> Gerar mês
          </button>
          <button class="btn success" id="punchNow">
            <i class="fas fa-fingerprint"></i> Bater ponto agora
          </button>
        </div>
        <div class="group grow"></div>
        <div class="group">
          <button class="btn" id="exportJson">
            <i class="fas fa-file-export"></i> Exportar JSON
          </button>
          <input type="file" id="importFile" accept="application/json" style="display:none">
          <button class="btn" id="importJson">
            <i class="fas fa-file-import"></i> Importar JSON
          </button>
          <button class="btn warn" id="exportPdf">
            <i class="fas fa-file-pdf"></i> Exportar PDF
          </button>
        </div>
      </div>

      <div class="titleline">
        <h1><i class="fas fa-clock"></i> Folha de ponto <span id="titleMonthYear" class="badge"></span></h1>
        <small id="summary">Total mês: 00:00 • Extras: 00:00 • Dias úteis: 0</small>
      </div>

      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-value" id="totalHours">00:00</div>
          <div class="stat-label">Total de Horas</div>
        </div>
        <div class="stat-box">
          <div class="stat-value positive" id="extraHours">00:00</div>
          <div class="stat-label">Horas Extras</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="workedDays">0</div>
          <div class="stat-label">Dias Trabalhados</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="remainingDays">0</div>
          <div class="stat-label">Dias Restantes</div>
        </div>
      </div>

      <div class="export-options" id="exportOptions" style="display: none;">
        <label>
          <input type="checkbox" id="exportOnlyFilled" checked> Exportar apenas dias preenchidos
        </label>
        <label>
          <input type="checkbox" id="includeStats" checked> Incluir estatísticas
        </label>
      </div>

      <div class="action-buttons">
        <button class="btn danger" id="clearData">
          <i class="fas fa-trash-alt"></i> Limpar todos os registros
        </button>
      </div>

      <div style="overflow:auto; max-height:60vh;">
        <table id="sheet">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
      </div>

      <div class="hint">
        <i class="fas fa-lightbulb"></i> Dica: os campos de hora aceitam <b>HH:MM</b>. Deixe em branco se não utilizar um período. <br>
        <i class="fas fa-moon"></i> Para horários que passam da meia-noite, digite normalmente (ex: 00:30, 01:15) - o sistema detecta automaticamente.<br>
        Extras = <i>máx( Total do dia − Alvo diário )</i>. Você pode alterar o alvo diário acima.
      </div>
    </div>
  </header>

  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3><i class="fas fa-exclamation-triangle"></i> Confirmar ação</h3>
      <p id="modalMessage">Tem certeza que deseja limpar todos os registros? Esta ação não pode ser desfeita.</p>
      <div class="modal-buttons">
        <button class="btn" id="modalCancel">Cancelar</button>
        <button class="btn danger" id="modalConfirm">Confirmar</button>
      </div>
    </div>
  </div>

<script>
/* ===== Helpers de data/tempo ===== */
const PT_WEEK = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
const PT_MONTH = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

function pad(n){ return String(n).padStart(2,'0'); }

function hmToMinutes(hm){
  if(!hm) return 0;
  const m = /^(\d{1,2}):([0-5]\d)$/.exec(hm.trim());
  if(!m) return NaN;
  const h=parseInt(m[1],10), min=parseInt(m[2],10);
  if(h>29) return NaN; // sane cap
  return h*60+min;
}
function minutesToHM(mins){
  const m = Math.max(0, Math.round(mins));
  const h = Math.floor(m/60), mi = m%60;
  return `${pad(h)}:${pad(mi)}`;
}

/* ===== Formatação automática de hora ===== */
function formatHourInput(input) {
  // Remove tudo que não é número
  let value = input.value.replace(/\D/g, '');
  
  // Limita a 4 dígitos
  if (value.length > 4) {
    value = value.substring(0, 4);
  }
  
  // Adiciona os dois pontos após o segundo dígito
  if (value.length > 2) {
    value = value.substring(0, 2) + ':' + value.substring(2);
  }
  
  input.value = value;
}

/* ===== Estado ===== */
let currentYear, currentMonth; // 0-11
let state = {}; // day -> { mIn,mOut,aIn,aOut,nIn,nOut, total, extra }

/* ===== UI setup ===== */
(function initSelectors(){
  const monthSel=document.getElementById('month');
  PT_MONTH.forEach((m,i)=>{
    const o=document.createElement('option'); o.value=i; o.textContent=`${pad(i+1)} - ${m}`;
    monthSel.appendChild(o);
  });
  const yearSel=document.getElementById('year');
  const now=new Date();
  for(let y=now.getFullYear()-3; y<=now.getFullYear()+3; y++){
    const o=document.createElement('option'); o.value=y; o.textContent=y; yearSel.appendChild(o);
  }
  monthSel.value=now.getMonth();
  yearSel.value=now.getFullYear();
  // auto generate on load
  generateMonth();
})();

/* ===== Construção da tabela ===== */
function generateMonth(){
  currentMonth=parseInt(document.getElementById('month').value,10);
  currentYear=parseInt(document.getElementById('year').value,10);
  state = {};
  document.getElementById('titleMonthYear').textContent = `${PT_MONTH[currentMonth]} / ${currentYear}`;

  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();

  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const tfoot = document.getElementById('tfoot');
  thead.innerHTML = tbody.innerHTML = tfoot.innerHTML = '';

  // Cabeçalho
  const tr1 = document.createElement('tr');
  tr1.innerHTML = `
    <th class="sticky-left" rowspan="2">Data<br><small>Dia</small></th>
    <th class="section" colspan="2">MANHÃ</th>
    <th class="section" colspan="2">TARDE</th>
    <th class="section" colspan="2">NOITE</th>
    <th class="section" rowspan="2">TOTAL</th>
    <th class="section" rowspan="2">EXTRAS</th>`;
  const tr2 = document.createElement('tr');
  tr2.innerHTML = `
    <th>Entrada</th><th>Saída</th>
    <th>Entrada</th><th>Saída</th>
    <th>Entrada</th><th>Saída</th>`;
  thead.appendChild(tr1); thead.appendChild(tr2);

  // Corpo
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(currentYear, currentMonth, d);
    const dow = date.getDay();
    const isWeekend = dow === 0 || dow === 6;
    
    const row = document.createElement('tr');
    row.dataset.day = d;
    if (isWeekend) {
      row.classList.add('weekend');
    }
    
    const dateCell = document.createElement('td');
    dateCell.className='sticky-left';
    dateCell.style.textAlign='left';
    
    const dayName = PT_WEEK[dow];
    const dayDisplay = isWeekend ? `<span class="weekend-label">${dayName}</span>` : dayName;
    
    dateCell.innerHTML = `<b>${pad(d)}/${pad(currentMonth+1)}/${currentYear}</b><br><small style="color:#6b7280">${dayDisplay}</small>`;
    row.appendChild(dateCell);

    // 6 inputs
    const keys = ['mIn','mOut','aIn','aOut','nIn','nOut'];
    keys.forEach(k=>{
      const td=document.createElement('td');
      const inp=document.createElement('input');
      inp.placeholder='--:--';
      inp.inputMode='numeric';
      inp.pattern='[0-2]\\d:[0-5]\\d';
      
      // Adiciona formatação automática
      inp.addEventListener('input', (e) => {
        formatHourInput(e.target);
      });
      
      inp.addEventListener('change', ()=> onCellEdit(d, k, inp.value));
      td.appendChild(inp);
      row.appendChild(td);
    });

    const tdTotal=document.createElement('td'); tdTotal.className='total'; tdTotal.textContent='00:00';
    const tdExtra=document.createElement('td'); tdExtra.className='extra'; tdExtra.textContent='00:00';
    row.appendChild(tdTotal); row.appendChild(tdExtra);
    tbody.appendChild(row);

    state[d] = { mIn:'',mOut:'',aIn:'',aOut:'',nIn:'',nOut:'', total:0, extra:0 };
  }

  // Rodapé resumo
  const trf=document.createElement('tr');
  trf.innerHTML = `
    <td class="sticky-left" style="text-align:left"><b>Totais do mês</b></td>
    <td colspan="5"></td>
    <td style="text-align:right"><b>Total</b></td>
    <td id="ftTotal" class="total">00:00</td>
    <td id="ftExtra" class="extra">00:00</td>`;
  tfoot.appendChild(trf);

  // Se existir rascunho no localStorage deste mês/ano, carregar
  const draftKey = draftStorageKey();
  const draft = localStorage.getItem(draftKey);
  if(draft){
    try{ importFromObject(JSON.parse(draft), false); }catch(e){}
  }

  updateSummary();
}

/* ===== Cálculo e validação ===== */
function computeDay(d){
  const targetH = parseFloat(document.getElementById('dailyTarget').value || "8");
  const targetMin = Math.round(targetH*60);
  const rec = state[d];

  // obter valores dos inputs (prioriza estado, assim import/edits refletem)
  const mins = [
    [hmToMinutes(rec.mIn), hmToMinutes(rec.mOut)],
    [hmToMinutes(rec.aIn), hmToMinutes(rec.aOut)],
    [hmToMinutes(rec.nIn), hmToMinutes(rec.nOut)],
  ];

  let total = 0;
  for(const [ini,fim] of mins){
    if(Number.isNaN(ini) || Number.isNaN(fim)){
      // valor inválido -> ignora no total
      continue;
    }
    if(ini>=0 && fim>=0){
      // Se horário de saída for menor que entrada, assume que passou para o dia seguinte
      let adjustedFim = fim;
      if(fim < ini){
        adjustedFim = fim + (24 * 60); // adiciona 24 horas
      }
      if(adjustedFim > ini) total += (adjustedFim - ini);
    }
  }

  const extra = Math.max(0, total - targetMin);

  rec.total = total; rec.extra = extra;

  // atualiza UI
  const row = document.querySelector(`tr[data-day="${d}"]`);
  if(row){
    row.querySelector('td.total').textContent = minutesToHM(total);
    row.querySelector('td.extra').textContent = minutesToHM(extra);
  }
}

function updateSummary(){
  // Totais gerais
  let sumT=0, sumE=0;
  let workedDays = 0;
  const days = Object.keys(state);
  
  for(const d of days){ 
    computeDay(d); 
    sumT += state[d].total; 
    sumE += state[d].extra; 
    
    // Contar dias trabalhados (pelo menos um campo preenchido)
    const rec = state[d];
    if(rec.mIn || rec.mOut || rec.aIn || rec.aOut || rec.nIn || rec.nOut) {
      workedDays++;
    }
  }
  
  document.getElementById('ftTotal').textContent = minutesToHM(sumT);
  document.getElementById('ftExtra').textContent = minutesToHM(sumE);
  document.getElementById('summary').textContent = `Total mês: ${minutesToHM(sumT)} • Extras: ${minutesToHM(sumE)} • Dias úteis: ${workedDays}`;
  
  // Atualizar estatísticas
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  const remainingDays = daysInMonth - workedDays;
  
  document.getElementById('totalHours').textContent = minutesToHM(sumT);
  document.getElementById('extraHours').textContent = minutesToHM(sumE);
  document.getElementById('workedDays').textContent = workedDays;
  document.getElementById('remainingDays').textContent = remainingDays;

  // salva rascunho do mês/ano atual (auto-save)
  localStorage.setItem(draftStorageKey(), JSON.stringify(exportObject()));
}

function onCellEdit(day, key, value){
  value = value.trim();
  if(value === ''){ state[day][key] = ''; updateSummary(); return; }
  const m = hmToMinutes(value);
  if(Number.isNaN(m)){
    alert('Hora inválida. Use HH:MM (ex.: 08:00)');
    // restaura valor anterior no input
    const row = document.querySelector(`tr[data-day="${day}"]`);
    const idx = ['mIn','mOut','aIn','aOut','nIn','nOut'].indexOf(key);
    if(row && idx>=0){ row.querySelectorAll('input')[idx].value = state[day][key]; }
    return;
  }
  state[day][key] = value;
  updateSummary();
  
  // Efeito visual de atualização
  const row = document.querySelector(`tr[data-day="${day}"]`);
  if(row) {
    row.classList.add('highlight');
    setTimeout(() => row.classList.remove('highlight'), 2000);
  }
}

/* ===== Bater ponto agora ===== */
function punchNow(){
  const now = new Date();
  if(now.getFullYear()!==currentYear || now.getMonth()!==currentMonth){
    alert('O mês atual da folha não corresponde à data de hoje.');
    return;
  }
  const d = now.getDate();
  const row = document.querySelector(`tr[data-day="${d}"]`);
  if (!row) {
    alert('Dia não encontrado na folha.');
    return;
  }
  
  const inputs = row.querySelectorAll('input');
  // encontra o próximo campo vazio na sequência mIn,mOut,aIn,aOut,nIn,nOut
  let idx = -1;
  for(let i = 0; i < inputs.length; i++) {
    if(!inputs[i].value.trim()) {
      idx = i;
      break;
    }
  }
  
  if(idx === -1){ 
    alert('Todos os campos deste dia já estão preenchidos.'); 
    return; 
  }
  
  const hhmm = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  inputs[idx].value = hhmm;
  const key = ['mIn','mOut','aIn','aOut','nIn','nOut'][idx];
  state[d][key] = hhmm;
  
  // Efeito visual
  inputs[idx].classList.add('punch-animation');
  setTimeout(() => inputs[idx].classList.remove('punch-animation'), 500);
  
  updateSummary();
}

/* ===== Limpar registros ===== */
function clearAllData() {
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  
  for(let d=1; d<=daysInMonth; d++){
    // Limpar estado
    state[d] = { mIn:'',mOut:'',aIn:'',aOut:'',nIn:'',nOut:'', total:0, extra:0 };
    
    // Limpar inputs
    const row = document.querySelector(`tr[data-day="${d}"]`);
    if(row){
      const inputs = row.querySelectorAll('input');
      inputs.forEach(input => input.value = '');
      
      const totals = row.querySelectorAll('td.total, td.extra');
      totals.forEach(td => td.textContent = '00:00');
    }
  }
  
  // Limpar localStorage
  localStorage.removeItem(draftStorageKey());
  
  updateSummary();
  
  // Feedback visual
  document.getElementById('sheet').classList.add('fade-in');
  setTimeout(() => document.getElementById('sheet').classList.remove('fade-in'), 500);
}

/* ===== Modal de confirmação ===== */
function showModal(message, confirmCallback) {
  const modal = document.getElementById('confirmModal');
  const modalMessage = document.getElementById('modalMessage');
  const modalCancel = document.getElementById('modalCancel');
  const modalConfirm = document.getElementById('modalConfirm');
  
  modalMessage.textContent = message;
  modal.style.display = 'flex';
  
  modalCancel.onclick = function() {
    modal.style.display = 'none';
  };
  
  modalConfirm.onclick = function() {
    modal.style.display = 'none';
    confirmCallback();
  };
}

/* ===== Export/Import JSON ===== */
function exportObject(){
  return {
    version:1,
    employee: document.getElementById('employee').value || '',
    year: currentYear,
    month: currentMonth, // 0-11
    dailyTarget: parseFloat(document.getElementById('dailyTarget').value || "8"),
    days: state
  };
}
function download(filename, text){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:'application/json'}));
  a.download=filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function doExportJSON(){
  const obj = exportObject();
  const fname = `folha-${pad(currentMonth+1)}-${currentYear}.json`;
  download(fname, JSON.stringify(obj, null, 2));
}

function importFromObject(obj, regenerateIfNeeded=true){
  if(typeof obj!=='object' || obj===null || obj.version!==1) throw new Error('JSON inválido');
  // Se JSON for de outro mês/ano, regenerar tabela para alinhar
  if(regenerateIfNeeded && (obj.year!==currentYear || obj.month!==currentMonth)){
    document.getElementById('year').value = obj.year;
    document.getElementById('month').value = obj.month;
    generateMonth();
  }
  document.getElementById('employee').value = obj.employee || '';
  document.getElementById('dailyTarget').value = obj.dailyTarget ?? 8;

  // Aplicar valores
  state = {};
  const daysInMonth = new Date(obj.year, obj.month+1, 0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const rec = (obj.days && obj.days[d]) ? obj.days[d] : {mIn:'',mOut:'',aIn:'',aOut:'',nIn:'',nOut:''};
    state[d] = { ...rec, total:0, extra:0 };
    // preencher inputs
    const row = document.querySelector(`tr[data-day="${d}"]`);
    if(row){
      const inputs = row.querySelectorAll('input');
      const vals = [rec.mIn||'',rec.mOut||'',rec.aIn||'',rec.aOut||'',rec.nIn||'',rec.nOut||''];
      vals.forEach((v,i)=> inputs[i].value = v);
    }
  }
  updateSummary();
}

function doImportJSON(){
  const fileInput = document.getElementById('importFile');
  fileInput.onchange = async (ev)=>{
    const f = ev.target.files[0];
    if(!f) return;
    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      importFromObject(obj);
    }catch(e){
      alert('Falha ao importar JSON.');
    }finally{
      fileInput.value='';
    }
  };
  fileInput.click();
}

/* ===== Exportar PDF ===== */
async function doExportPDF(){
  // Verifique se o jsPDF está carregado corretamente
  if (typeof window.jspdf === 'undefined') {
    alert('Biblioteca PDF não carregada. Tente recarregar a página.');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
  const margin = 36;

  const monthName = PT_MONTH[currentMonth];
  const title = `Folha de Ponto — ${monthName}/${currentYear}`;
  const employee = document.getElementById('employee').value || 'Funcionário: ________';
  const targetH = parseFloat(document.getElementById('dailyTarget').value || "8");
  const exportOnlyFilled = document.getElementById('exportOnlyFilled').checked;
  const includeStats = document.getElementById('includeStats').checked;

  // Cabeçalho
  doc.setFont('helvetica','bold'); 
  doc.setFontSize(16);
  doc.text(title, margin, 40);
  doc.setFontSize(11); 
  doc.setFont('helvetica','normal');
  doc.text(`${employee}   •   Alvo diário: ${targetH}h`, margin, 60);

  // Montar dados tabulares
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  const body = [];
  
  for(let d=1; d<=daysInMonth; d++){
    const rec = state[d];
    
    // Verificar se deve exportar apenas dias preenchidos
    if (exportOnlyFilled) {
      const hasData = rec.mIn || rec.mOut || rec.aIn || rec.aOut || rec.nIn || rec.nOut;
      if (!hasData) continue;
    }
    
    const date = new Date(currentYear, currentMonth, d);
    const dayOfWeek = PT_WEEK[date.getDay()];
    
    body.push([
      `${pad(d)}/${pad(currentMonth+1)}/${currentYear} (${dayOfWeek})`,
      rec.mIn||'--:--', 
      rec.mOut||'--:--',
      rec.aIn||'--:--', 
      rec.aOut||'--:--',
      rec.nIn||'--:--', 
      rec.nOut||'--:--',
      minutesToHM(rec.total||0),
      minutesToHM(rec.extra||0)
    ]);
  }

  // Se não houver dados para exportar
  if (body.length === 0) {
    alert('Nenhum dia preenchido para exportar.');
    return;
  }

  // Usar a API correta do autoTable
  doc.autoTable({
    startY: 80,
    theme: 'grid',
    head: [[
      'Data/Dia', 'Manhã E', 'Manhã S', 'Tarde E', 'Tarde S', 'Noite E', 'Noite S', 'Total', 'Extras'
    ]],
    body: body,
    styles: { 
      fontSize: 9, 
      cellPadding: 4,
      halign: 'center'
    },
    headStyles: { 
      fillColor: [35, 99, 235],
      textColor: 255,
      fontStyle: 'bold'
    },
    columnStyles: {
      0: { halign: 'left', cellWidth: 90 },
      7: { fontStyle: 'bold', fillColor: [234, 242, 255] },
      8: { fontStyle: 'bold', fillColor: [255, 246, 229] }
    }
  });

  // Adicionar estatísticas se solicitado
  if (includeStats) {
    let sumT = 0, sumE = 0, workedDays = 0; 
    Object.values(state).forEach(r => {
      sumT += r.total || 0; 
      sumE += r.extra || 0;
      if (r.mIn || r.mOut || r.aIn || r.aOut || r.nIn || r.nOut) workedDays++;
    });
    
    const y = doc.lastAutoTable.finalY + 24;
    doc.setFont('helvetica','bold'); 
    doc.setFontSize(11);
    doc.text(`Total mês: ${minutesToHM(sumT)}    •    Extras: ${minutesToHM(sumE)}    •    Dias trabalhados: ${workedDays}`, margin, y);
  }

  // Adicionar data de geração
  const now = new Date();
  doc.setFontSize(9);
  doc.setFont('helvetica','normal');
  doc.text(`Gerado em: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, margin, doc.internal.pageSize.height - 20);
  
  const exportType = exportOnlyFilled ? 'preenchidos' : 'completo';
  doc.save(`folha-${pad(currentMonth+1)}-${currentYear}-${exportType}.pdf`);
}

/* ===== Draft Key ===== */
function draftStorageKey(){
  return `folhaPonto:${currentYear}-${pad(currentMonth+1)}`;
}

/* ===== Listeners ===== */
document.getElementById('generate').addEventListener('click', generateMonth);
document.getElementById('punchNow').addEventListener('click', punchNow);
document.getElementById('exportJson').addEventListener('click', doExportJSON);
document.getElementById('importJson').addEventListener('click', doImportJSON);
document.getElementById('exportPdf').addEventListener('click', doExportPDF);
document.getElementById('dailyTarget').addEventListener('change', updateSummary);
document.getElementById('clearData').addEventListener('click', function() {
  showModal('Tem certeza que deseja limpar todos os registros? Esta ação não pode ser desfeita.', clearAllData);
});

// Mostrar opções de exportação quando o botão de PDF for focado
document.getElementById('exportPdf').addEventListener('mouseover', function() {
  document.getElementById('exportOptions').style.display = 'block';
});

// Esconder opções de exportação quando o mouse sair da área
document.getElementById('exportOptions').addEventListener('mouseleave', function() {
  this.style.display = 'none';
});

// Fechar modal ao clicar fora dele
window.addEventListener('click', function(event) {
  const modal = document.getElementById('confirmModal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
});

</script>
</body>
</html>